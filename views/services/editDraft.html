{{left_sidebar_enabled,right_sidebar_enabled=False,('message' in globals())}}
{{extend 'layout.html'}}

{{block head_css}}
<link rel="stylesheet" href="{{=URL('static','css/sweetalert.css')}}"/>
<link rel="stylesheet" href="{{=URL('static','css/bootstrap-datepicker.min.css')}}"/>
<link rel="stylesheet" href="{{=URL('static','css/jquery.timepicker.css')}}"/>
{{end}}

{{block web2py_ajax}}{{end}}

<!-- container principal -->
<div class="container">
  <ol class="breadcrumb">
    <li><a href="{{=URL('services','index.html')}}">Servicios</a></li>
    <li class="active">Editar borrador</li>
  </ol>

  <!-- Número de servicio -->
  <div id="serviceNumber">
    <h2>Servicio <kbd>{{=service.id}}</kbd></h2>
    <hr>
  </div>

  <!-- Formulario -->
  <form action="" method="POST" id="registro" onsubmit="return validateForm()">
    <input type="hidden" name="id" value="{{=service.id}}">

    <!-- Nav tabs -->
    <ul class="nav nav-tabs" role="tablist">
      <li class="nav-item active"><a class="nav-link" data-toggle="tab" href="#basicinfo" role="tab">Info. básica</a></li>
      <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#commission" role="tab">Comisiones</a></li>
      <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#affected" role="tab">Afectados</a></li>
      <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#externalSupport" role="tab">Apoyo externo</a></li>
      <li class="nav-item navbar-right"><button id="btn-submit" type="button" class="btn bg-1"><span>Enviar </span></button></li>
      <li class="nav-item navbar-right">
        <button formnovalidate class="btn bg-1" type="submit" onclick="saveDraft()" name="draft" value="true">
          <span>Guardar borrador </span>
          <span class="glyphicon glyphicon-floppy-disk"></span>
        </button>
      </li>
      <li class="nav-item navbar-right">
        <button class="btn bg-1" type="button" data-toggle="modal" data-target="#eliminarServicioModal"><span>Descartar borrador</span></button>
      </li>
    </ul>

    <!-- Lista de autocompletado de nombres de bomberos -->
    <datalist id="firefighterList">
    {{for nombre in nombreBomberos:}}
    <option value="{{=nombre}}"></option>
    {{pass}}
    </datalist>

    <!-- Tab Información Básica -->
    <div class="tab-content top-space-separator">
      <div class="tab-pane active" id="basicinfo" role="tabpanel">
        <div class="col-xs-12 col-sm-6">
          <div class="row">
            <div class="col-xs-12 col-sm-4">
              <div class="form-group">
                <label for="startDate">Tipo de Servicio *</label>
                <select name="tipo" class="form-control" data-validation="required">
                  <option value="">Seleccionar</option>
                  <option value="CM">CM</option>
                  <option value="AME1">AME1</option>
                  <option value="AME2">AME2</option>
                  <option value="IDE">IDE</option>
                  <option value="IDV">IDV</option>
                  <option value="PC">PC</option>
                  <option value="AY">AY</option>
                  <option value="MP">MP</option>
                  <option value="RES1">RES1</option>
                  <option value="RES2">RES2</option>
                  <option value="SE">SE</option>
                  <option value="GP">GP</option>
                  <option value="NSA">NSA: No se actuó</option>
                  <option value="FA">FA: Falsa Alarma</option>
                </select>
              </div>
            </div>
          </div><div class="form-group" id="jqueryExample">
            <div class="row">
              <div class="col-xs-12 col-sm-12">
                <label for="startDate">Fecha de Inicio *
                  <input type="text" class="date start form-control" id="startDate" name="fechaCreacion" placeholder="introduzca una fecha"/>
                </label>
                <label for="startTime">Hora de Inicio *
                  <input type="text" class="time start form-control" id="startTime" name="horaCreacion" data-validation="required" placeholder="introduzca una hora"/>
                </label>
              </div>
            </div>
            <div class="row">
              <div class="col-xs-12 col-sm-12">
                <label for="endDate">Fecha de Fin *
                  <input type="text" class="date end form-control " id="endDate" name="fechaFinalizacion" placeholder="introduzca una fecha"/>
                </label>
                <label for="endTime">Hora de Fin *
                  <input type="text" class="time end form-control" id="endTime" name="horaFinalizacion" placeholder="introduzca una hora"/>
                </label>
              </div>
            </div>
          </div>
        </div>
        <div class="col-xs-12 col-sm-6">
          <div class="form-group">
            <label for="description">Descripción *</label>
            <textarea id="description" class="form-control" rows="5" name="descripcion" data-validation="required">{{=service.descripcion}}</textarea>
          </div>
          <div class="form-group">
            <label for="address">Dirección *</label>
            <textarea id="address" class="form-control" rows="2" name="localizacion" data-validation="required">{{=service.localizacion}}</textarea>
          </div>
        </div>
      </div>

      <!-- Tab Comisiones -->
      <div class="tab-pane fade" id="commission" role="tabpanel">
        {{for comision in comisiones:}}
          <div id="commissionsCNT">
            <div id="commission{{=comision['numero']}}">
              <div class="row">
                <div class="col-xs-12">
                  <h3 id="commissionTitle{{=comision['numero']}}" name="commissionTitle{{=comision['numero']}}">Comisión <kbd>1</kbd></h3>
                  <input type="hidden" name="commissionTitle{{=comision['numero']}}" value="commissionTitle{{=comision['numero']}}">
                </div>
              </div>
              <div class="row">
                <div class="col-xs-12 col-sm-4">
                  <div class="form-group ui-widget">
                    <label for="commissionBoss{{=comision['numero']}}">Jefe de comisión *</label>
                    <input list="firefighterList" name="commissionBoss{{=comision['numero']}}" class="form-control" data-validation="required" placeholder="Jefe de Comisión" value="{{=comision['jefe']}}">
                  </div>
                  <label for="unitTitle">Unidades</label>
                  <div class="row">
                    <div id="unitsCNT{{=comision['numero']}}">
                      <div id="unit{{=comision['numero']}}-1">
                        <div class="col-xs-4 col-sm-2">
                          <select id="unitValue{{=comision['numero']}}-1" class="form-control" name="unitValue{{=comision['numero']}}-1">
                            <option value="" selected="selected">--</option>
                            {{for unidad in nombreUnidades:}}
                              <option value="{{=unidad}}">{{=unidad}}</option>
                            {{pass}}
                          </select>
                        </div>
                        <div class="col-xs-8 col-sm-10">
                          <input list="firefighterList" name="commissionDriver{{=comision['numero']}}-1" class="form-control" placeholder="Conductor" value="{{=comision['conductor']}}">
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-xs-12 col-sm-4">
                  <div id="commissionMembersCNT1">
                    <label for="commissionMember{{=comision['numero']}}-1">Acompañantes</label>
                    {{for i in range(len(comision['acompanantes'])):}}
                      <input list="firefighterList" name="commissionMember{{=comision['numero']}}-{{=i+1}}" class="form-control" placeholder="Acompañante de Comisión" value="{{=comision['acompanantes'][i]}}">
                    {{pass}}
                  </div>
                  {{for i in range(len(comision['acompanantes']),3):}}
                      <input list="firefighterList" name="commissionMember{{=comision['numero']}}-{{=i+1}}" class="form-control" placeholder="Acompañante de Comisión">
                  {{pass}}
                  <div class="text-right">
                    <button id="addCommissionMember{{=comision['numero']}}" type="button" class="btn bg-1 addCommissionMember top-space-separator addCommissionMember">
                      <small>Añadir acompañante <span class="glyphicon glyphicon-user"></span></small>
                    </button>
                  </div>
                </div>
              </div>
            </div>
            <hr>
          </div>
        {{pass}}
        <div class="text-center">
          <button id="addCommission" type="button" class="btn bg-1">
            Añadir otra comision
            <span class="glyphicon glyphicon-plus-sign"></span>
          </button>
        </div>
      </div>

      <!-- Tab Afectados -->
      <div class="tab-pane fade" id="affected" role="tabpanel">
        {{for afectado in afectados:}}
          <div id="affectedCNT">          
            <div id="affected{{=afectado['counter']}}">
              <div class="row">
                <div class="col-xs-12 col-sm-6">
                  <div class="row">
                    <div class="col-xs-12 col-sm-12">
                      <div class="input-group">
                        <span class="input-group-btn">
                          <button class="removeButton removeGroup" type="button"><span class="glyphicon glyphicon-remove"></span></button>
                        </span>
                        <h3>Afectado <kbd>{{=afectado['counter']}}</kbd></h3>
                      </div>
                      <input type="hidden" name="affectedTitle{{=afectado['counter']}}" value="affectedTitle{{=afectado['counter']}}">
                      <label>Nombre *</label>
                    </div>
                    <div class="col-xs-6 col-sm-4 form-group">
                      <input type="text" class="form-control" id="affectedFirstName{{=afectado['counter']}}" name="affectedFirstName{{=afectado['counter']}}" data-validation="required" placeholder="Primer Nombre *" value="{{=afectado['primer_nombre']}}">
                    </div>
                    <div class="col-xs-6 col-sm-4 form-group">
                      <input type="text" class="form-control" id="affectedFirstSurname{{=afectado['counter']}}" name="affectedFirstSurname{{=afectado['counter']}}" data-validation="required" placeholder="Primer Apellido *" value="{{=afectado['primer_apellido']}}">
                    </div>
                    <div class="col-xs-6 col-sm-4 form-group">
                      <label for="affectedName3" class="sr-only"><small>2do Apellido</small></label>
                      <input type="text" class="form-control" id="affectedSecondSurname{{=afectado['counter']}}" name="affectedSecondSurname{{=afectado['counter']}}" placeholder="Segundo Apellido" value="{{=afectado['segundo_apellido']}}">
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-xs-12 col-sm-4 form-group">
                      <label for="affectedCI{{=afectado['counter']}}">Cedula</label>
                      <input type="text" class="form-control" id="affectedCI{{=afectado['counter']}}" name="affectedCI{{=afectado['counter']}}" data-validation="required" data-validation="number" placeholder="Número de Cedula" value="{{=afectado['cedula']}}">
                    </div>
                    <div class="col-xs-4 col-sm-2">
                      <div class="form-group">
                        <label for="affectedGender{{=afectado['counter']}}">Sexo</label>
                        <select class="form-control" id="affectedGender{{=afectado['counter']}}" data-validation="required" name="affectedGender{{=afectado['counter']}}">
                          <option value="-" {{if afectado['sexo']=="-":}}selected="selected"{{pass}}>-</option>
                          <option value="F" {{if afectado['sexo']=="F":}}selected="selected"{{pass}}>F</option>
                          <option value="M" {{if afectado['sexo']=="M":}}selected="selected"{{pass}}>M</option>
                        </select>
                      </div>
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-xs-12 col-sm-6 form-group">
                      <label for="affectedType{{=afectado['counter']}}">Tipo</label>
                      <select class="form-control" id="affectedType{{=afectado['counter']}}" name="affectedType{{=afectado['counter']}}" data-validation="required">
                        <option value="" {{if afectado['tipo']=="":}}selected="selected"{{pass}}>Seleccione tipo de afectado</option>
                        <option value="1"{{if afectado['tipo']=="1":}}selected="selected"{{pass}}>Estudiante de la USB</option>
                        <option value="2"{{if afectado['tipo']=="2":}}selected="selected"{{pass}}>Profesor de la USB</option>
                        <option value="3"{{if afectado['tipo']=="3":}}selected="selected"{{pass}}>Empleado de la USB</option>
                        <option value="4"{{if afectado['tipo']=="4":}}selected="selected"{{pass}}>Obrero de la USB</option>
                        <option value="5"{{if afectado['tipo']=="5":}}selected="selected"{{pass}}>Externo</option>
                      </select>
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-xs-12 col-sm-6">
                      <div id="emailsCNT{{=afectado['counter']}}">
                        <label for="emailsTitle">Correos Electrónicos</label>
                      </div>
                      <div class="text-right">
                        <button id="addAffectedEmail{{=afectado['counter']}}" type="button" class="btn bg-1 addAffectedEmail top-space-separator">+ <span class="glyphicon glyphicon-envelope"></span></button>
                      </div>
                    </div>
                    <div class="col-xs-12 col-sm-6">
                      <div id="phonesCNT{{=afectado['counter']}}">
                        <label for="phonesTitle">Teléfonos</label>
                        {{for i in range(len(afectado['numeros'])):}}
                          <div class="input-group">
                            <input type="tel" class="form-control" id="affectedPhone{{=afectado['counter']}}-{{=i+1}}" name="affectedPhone{{=afectado['counter']}}-{{=i+1}}" data-validation="length" data-validation-length="12-20" data-validation="number" data-validation-allowing="-+()" placeholder="Teléfono/Celular" value='{{=afectado["numeros"][i]}}'>
                            <span class="input-group-btn">
                            <button class="removeButton removeField" type="button"><span class="glyphicon glyphicon-remove"></span></button>
                            </span>
                          </div>;
                        {{pass}} 
                      </div>
                      <div class="text-right">
                        <button id="addAffectedPhone{{=afectado['counter']}}" type="button" class="btn bg-1 addAffectedPhone top-space-separator">+ <span class="glyphicon glyphicon-earphone"></span></button>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-xs-6 col-sm-5 col-sm-offset-1">
                  <br />
                  <br />
                  <br />
                  <label>Notas/Tratamiento</label>
                  <div class="form-group">
                    <textarea id="affectedNotes{{=afectado['counter']}}" name="affectedNotes{{=afectado['counter']}}" class="form-control" data-validation="length" data-validation-length="max700" rows="10">{{=afectado['notastratamiento']}}</textarea>
                    </div>
                </div>
              </div>
              <hr>
            </div>
          </div>
        {{pass}}
        <div class="text-center">
          <button id="addAffected" type="button" class="btn bg-1">
            Añadir afectado
            <span class="glyphicon glyphicon-plus-sign"></span>
          </button>
        </div>
      </div>

      <!-- Tab Apoyo Externo -->
      <div class="tab-pane fade" id="externalSupport" role="tabpanel">
        {{for externo in externos:}}
          <div id="comExtCNT">
            <div id="comExt{{=externo['counter']}}" class="row">
              <div class="col-xs-12 col-sm-6">
                <div id="comisionExt{{=externo['counter']}}" class="col-xs-12 col-sm-12">
                  <h3 id="comisionExtTitle{{=externo['counter']}}" name="comisionExtTitle{{=externo['counter']}}">Comisión Externa <kbd>{{=externo['counter']}}</kbd></h3>
                  <input type="hidden" name="comisionExtTitle{{=externo['counter']}}" value="comisionExtTitle{{=externo['counter']}}">
                  <div class="form-group ui-widget col-xs-12 col-sm-12">
                    <label for="cuerpoDepartamento{{=externo['counter']}}">Cuerpo o Departamento</label>
                    <input id="cuerpoDepartamento{{=externo['counter']}}" type="text" class="form-control" placeholder="Nombre del Departamento" name="cuerpoDepartamento{{=externo['counter']}}" value="{{=externo['cuerpoDepartamento']}}">
                  </div>
                  <div class="form-group ui-widget col-xs-12 col-sm-7">
                    <label for="jefe{{=externo['counter']}}">Jefe</label>
                    <input id="jefe{{=externo['counter']}}" type="text" class="form-control" placeholder="Nombre" name="jefe{{=externo['counter']}}" value="{{=externo['jefe']}}">
                  </div>
                  <div class="col-xs-12 col-sm-5">
                    <label for="cuerpoDepartamento{{=externo['counter']}}">Número de acompañantes</label>
                    <input id="numAcomp{{=externo['counter']}}" type="text" class="form-control" data-validation="length" data-validation-length="max4" data-validation="number" placeholder="Número" name="numAcomp{{=externo['counter']}}" value="{{=externo['numAcomp']}}">
                  </div>
                  <div id="unitExtCNT{{=externo['counter']}}">
                    <div id="unitExt{{=externo['counter']}}-1">
                      <div class="col-xs-6 col-sm-6">
                        <label for="unitExtValue{{=externo['counter']}}-1">Unidades</label>
                        <input id="unitExtValue{{=externo['counter']}}-1" type="text" class="form-control" placeholder="Unidad" name="unitExtValue{{=externo['counter']}}-1" value="{{=externo['unidad']}}">
                      </div>
                      <div class="col-xs-6 col-sm-6">
                        <label for="unitExtValue{{=externo['counter']}}-1">Placa Unidad</label>
                        <input id="unitExtPlaca{{=externo['counter']}}-1" type="text" class="form-control col-xs-6" placeholder="Conductor" name="unitExtPlaca{{=externo['counter']}}-1" value="{{=externo['placa']}}">
                      </div>
                    </div>
                  </div>
                  <div class="col-xs-12 text-right">
                    <button id="addUnitExt{{=externo['counter']}}" type="button" class="btn bg-1 addUnitExt top-space-separator">
                      <small>Añadir unidad externa<span class="glyphicon glyphicon-wrench"></span></small>
                    </button>
                  </div>
                </div>
              </div>
              <div class="col-xs-6 col-sm-5 col-sm-offset-1">
                <br />
                <br />
                <br />
                <label>Comentario</label>
                <div class="form-group">
                  <textarea id="affectedNotes{{=externo['counter']}}" name="affectedNotes{{=externo['counter']}}" class="form-control" data-validation="length" data-validation-length="max 600" rows="9">{{=externo['comentario']}}</textarea>
                </div>
              </div>
            </div>
            <hr>
          </div>
        {{pass}}
        <div class="text-center">
          <button id="addApoyoExt" type="button" class="btn bg-1">
            Añadir apoyo externo
            <span class="glyphicon glyphicon-plus-sign"></span>
          </button>
        </div>
      </div>
    </div>
  </form>

  <!-- Modal para confirmacion de eliminacion de servicio -->
  <div class="modal fade" id="eliminarServicioModal" role="dialog">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header text-center">
          <h4 class="modal-title">Eliminar Borrador</h4>
        </div>
        <div class="modal-body text-center">
          <p>¿Está seguro que desea eliminar el borrador?</p>
        </div>
        <div class="modal-footer">
          <div class="row text-center">
            <form method="post" action={{=URL('services','deleteMyService', vars=dict(row_id=service.id))}}>
              <button type="button" class="btn bg-1" data-dismiss="modal"><span>Cancelar</span></button>
              <button type="submit" class="btn bg-1"><span>Continuar</span></button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{{block page_js}}
<script>{{=ASSIGNJS(nombres = nombreBomberos)}}</script>                         <!-- Script para conectar con la base de nombre de bomberos -->
<script>

{{=ASSIGNJS(tipoS = service.tipo)}}

{{=ASSIGNJS(fechaCreacionS = str(service.fechaCreacion))}}
{{=ASSIGNJS(horaCreacionS = str(service.horaCreacion))}}

{{=ASSIGNJS(fechaFinalizacionS = str(service.fechaFinalizacion))}}
{{=ASSIGNJS(horaFinalizacionS = str(service.horaFinalizacion))}}


{{=ASSIGNJS(comisionesS = [1,1,1])}}

</script>
<script src="{{=URL('static','js/services/registerValidation.js')}}"></script>  <!-- Script para validar el form de registro de servicio -->
<script src="{{=URL('static','js/services/registerForm.js')}}"></script>        <!-- Script para efectos en el form de registro de servicio -->
<script src="{{=URL('static','js/services/editDraft.js')}}"></script>           <!-- Script para form de registro de borrador (funciones extra) -->
<script src="{{=URL('static','js/sweetalert.min.js')}}"></script>               <!-- Script para mensajes de alerta -->
<script src="{{=URL('static','js/bootstrap-datepicker.min.js')}}"></script>     <!-- Script para el calendario -->
<script src="{{=URL('static','js/jquery.timepicker.min.js')}}"></script>        <!-- Script para el selector de hora -->
<script src="{{=URL('static','js/jquery.datepair.min.js')}}"></script>          <!-- Script para parear las fechas -->
<script src="{{=URL('static','js/jquery.form-validator.min.js')}}"></script>    <!-- Script para validar campos del formulario -->
<script>$.validate({form : '#registro', lang: 'es', });</script>                <!-- Script para configurar el script anterior xD -->
<!-- Google Maps -->
<!--<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBu5nZKbeK-WHQ70oqOWo-_4VmwOwKP9YQ"></script>-->
{{end}}